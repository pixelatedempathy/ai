# Pixelated Empathy AI - Notification Integration System

## Overview

The Notification Integration System provides comprehensive alerting capabilities for the Pixelated Empathy AI platform, supporting multiple notification channels with intelligent routing based on alert priority levels.

## Features

### ðŸš€ **Multi-Channel Support**
- **Email**: SMTP-based email notifications with HTML formatting
- **Slack**: Rich webhook notifications with attachments and formatting
- **PagerDuty**: Critical alert integration for incident management
- **Webhooks**: Generic webhook support for custom integrations

### ðŸŽ¯ **Intelligent Priority Routing**
- **LOW**: Slack notifications only
- **MEDIUM**: Email + Slack notifications
- **HIGH**: Email + Slack + PagerDuty notifications
- **CRITICAL**: All available channels

### ðŸ”§ **Advanced Features**
- Asynchronous notification delivery for high performance
- Alert cooldown periods to prevent notification spam
- Comprehensive error handling and retry logic
- Alert history tracking and analytics
- System health monitoring integration
- External alert processing capabilities

## Quick Start

### 1. Installation

```bash
# Install dependencies
pip install -r notification_requirements.txt

# Make scripts executable
chmod +x setup_notifications.sh
chmod +x manage_escalation.sh
```

### 2. Configuration

Run the interactive setup script:

```bash
./setup_notifications.sh
```

Or manually configure environment variables:

```bash
# Email Configuration
export EMAIL_USER="your-email@example.com"
export EMAIL_PASSWORD="your-app-password"
export EMAIL_RECIPIENTS="admin@company.com,ops@company.com"

# Slack Configuration
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
export SLACK_CHANNEL="#pixelated-ai-alerts"

# PagerDuty Configuration
export PAGERDUTY_INTEGRATION_KEY="your-pagerduty-integration-key"

# Webhook Configuration
export WEBHOOK_URLS="https://webhook1.com,https://webhook2.com"
```

### 3. Testing

```bash
# Test all notification channels
python3 test_notifications.py all

# Test specific channels
python3 test_notifications.py channels

# Test priority routing
python3 test_notifications.py priorities
```

## Usage Examples

### Basic Alert Sending

```python
import asyncio
from notification_integrations import NotificationManager, NotificationPriority

async def send_alert():
    manager = NotificationManager()
    
    # Send a medium priority alert
    results = await manager.send_alert(
        title="High Memory Usage Detected",
        message="Memory usage has exceeded 85% threshold on server-01",
        priority=NotificationPriority.MEDIUM,
        metadata={
            "server": "server-01",
            "memory_usage": "87%",
            "threshold": "85%"
        }
    )
    
    # Check results
    for channel, success in results.items():
        print(f"{channel.value}: {'âœ…' if success else 'âŒ'}")

# Run the example
asyncio.run(send_alert())
```

### Custom Channel Selection

```python
from notification_integrations import NotificationChannel

# Send to specific channels only
results = await manager.send_alert(
    title="Custom Alert",
    message="This goes to email and Slack only",
    priority=NotificationPriority.HIGH,
    channels=[NotificationChannel.EMAIL, NotificationChannel.SLACK]
)
```

### Monitoring Integration

```python
from monitoring_notification_bridge import MonitoringBridge

async def setup_monitoring():
    bridge = MonitoringBridge()
    
    # Setup default alert rules
    bridge.setup_default_alert_rules()
    
    # Record metrics
    bridge.record_metric("cpu_usage_percent", 45.2, "%", "api-server")
    bridge.record_metric("memory_usage_percent", 67.8, "%", "api-server")
    
    # Check for alert conditions
    await bridge.check_alert_conditions()
    
    # Start continuous monitoring
    await bridge.start_monitoring_loop(check_interval=60)

asyncio.run(setup_monitoring())
```

## Configuration Files

### Environment Configuration (`.env.notifications`)
```bash
# Generated by setup_notifications.sh
EMAIL_USER="admin@pixelated-ai.com"
EMAIL_PASSWORD="app-specific-password"
SMTP_SERVER="smtp.gmail.com"
SMTP_PORT="587"
EMAIL_RECIPIENTS="admin@company.com,ops@company.com"

SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."
SLACK_CHANNEL="#pixelated-ai-alerts"
SLACK_TOKEN="xoxb-..."

PAGERDUTY_INTEGRATION_KEY="integration-key"
PAGERDUTY_API_TOKEN="api-token"

WEBHOOK_URLS="https://webhook1.com,https://webhook2.com"
```

### JSON Configuration (`notification_config.json`)
```json
{
  "smtp_server": "smtp.gmail.com",
  "smtp_port": 587,
  "email_user": "admin@pixelated-ai.com",
  "email_password": "app-specific-password",
  "default_recipients": ["admin@company.com", "ops@company.com"],
  
  "slack_webhook_url": "https://hooks.slack.com/services/...",
  "slack_token": "xoxb-...",
  "slack_channel": "#pixelated-ai-alerts",
  
  "pagerduty_integration_key": "integration-key",
  "pagerduty_api_token": "api-token",
  
  "webhook_urls": ["https://webhook1.com", "https://webhook2.com"]
}
```

## Alert Rules and Monitoring

### Default Alert Rules

The system includes pre-configured alert rules for common metrics:

| Rule Name | Metric | Threshold | Priority | Cooldown |
|-----------|--------|-----------|----------|----------|
| high_cpu_usage | cpu_usage_percent | > 85% | MEDIUM | 10 min |
| critical_cpu_usage | cpu_usage_percent | > 95% | HIGH | 5 min |
| high_memory_usage | memory_usage_percent | > 80% | MEDIUM | 10 min |
| critical_memory_usage | memory_usage_percent | > 90% | HIGH | 5 min |
| large_processing_queue | queue_size | > 1000 | MEDIUM | 15 min |
| critical_processing_queue | queue_size | > 5000 | HIGH | 10 min |
| high_error_rate | error_rate_percent | > 5% | MEDIUM | 10 min |
| critical_error_rate | error_rate_percent | > 15% | HIGH | 5 min |

### Custom Alert Rules

```python
# Add custom alert rule
bridge.add_alert_rule(
    rule_name="custom_metric_alert",
    metric_name="custom_metric",
    threshold=100.0,
    operator=">",
    priority="high",
    cooldown_minutes=20
)
```

## API Reference

### NotificationManager

#### Methods

- `send_alert(title, message, priority, channels=None, metadata=None)`: Send an alert
- `send_notification(message)`: Send a notification message object

### MonitoringBridge

#### Methods

- `setup_default_alert_rules()`: Setup default monitoring rules
- `add_alert_rule(rule_name, metric_name, threshold, operator, priority, cooldown_minutes)`: Add custom rule
- `record_metric(metric_name, value, unit, service_name, status)`: Record a system metric
- `check_alert_conditions()`: Check all alert conditions
- `process_external_alerts(alert_data)`: Process external alerts
- `start_monitoring_loop(check_interval)`: Start continuous monitoring
- `get_alert_history(hours)`: Get recent alert history
- `get_system_health_summary()`: Get current system health

### Priority Levels

```python
from notification_integrations import NotificationPriority

NotificationPriority.LOW       # Informational alerts
NotificationPriority.MEDIUM    # Warning alerts
NotificationPriority.HIGH      # Error alerts requiring attention
NotificationPriority.CRITICAL  # Critical alerts requiring immediate action
```

### Notification Channels

```python
from notification_integrations import NotificationChannel

NotificationChannel.EMAIL      # Email notifications
NotificationChannel.SLACK      # Slack notifications
NotificationChannel.PAGERDUTY  # PagerDuty notifications
NotificationChannel.WEBHOOK    # Generic webhook notifications
```

## Testing and Validation

### Test Commands

```bash
# Test all functionality
python3 test_notifications.py all

# Test individual channels
python3 test_notifications.py channels

# Test priority routing
python3 test_notifications.py priorities

# Test concurrent notifications
python3 test_notifications.py concurrent

# Test error handling
python3 test_notifications.py errors
```

### Health Checks

```python
# Get system health summary
health = bridge.get_system_health_summary()
print(json.dumps(health, indent=2))

# Get recent alerts
alerts = bridge.get_alert_history(hours=24)
print(f"Alerts in last 24h: {len(alerts)}")
```

## Integration with Existing Systems

### Prometheus/Grafana Integration

The notification system can be integrated with Prometheus alerts:

```yaml
# prometheus-alerts.yml
groups:
  - name: pixelated-ai-alerts
    rules:
      - alert: HighCPUUsage
        expr: cpu_usage_percent > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value }}%"
```

### API Endpoint Integration

```python
from flask import Flask, request
import asyncio

app = Flask(__name__)
bridge = MonitoringBridge()

@app.route('/webhook/alerts', methods=['POST'])
def receive_alert():
    alert_data = request.json
    
    # Process alert asynchronously
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    result = loop.run_until_complete(
        bridge.process_external_alerts(alert_data)
    )
    loop.close()
    
    return {"status": "processed", "results": result}
```

## Security Considerations

### Credential Management
- Store sensitive credentials in environment variables
- Use app-specific passwords for email authentication
- Rotate API keys and tokens regularly
- Limit webhook endpoint access with authentication

### Data Protection
- Alert messages may contain sensitive system information
- Ensure notification channels are properly secured
- Consider encryption for webhook payloads
- Implement audit logging for notification activities

## Troubleshooting

### Common Issues

#### Email Notifications Not Working
```bash
# Check SMTP configuration
python3 -c "
import smtplib
server = smtplib.SMTP('smtp.gmail.com', 587)
server.starttls()
# Test connection
"
```

#### Slack Notifications Failing
- Verify webhook URL is correct and active
- Check Slack app permissions
- Validate JSON payload format

#### PagerDuty Integration Issues
- Confirm integration key is valid
- Check PagerDuty service configuration
- Verify event payload format

### Debug Mode

Enable debug logging:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### Log Files

Check log files for detailed error information:
- Application logs: `/home/vivi/pixelated/ai/logs/`
- System logs: `/var/log/`

## Performance Optimization

### Async Operations
- All notifications are sent asynchronously
- Concurrent notification delivery to multiple channels
- Non-blocking alert processing

### Resource Usage
- Minimal memory footprint
- Efficient database operations
- Connection pooling for external APIs

### Scalability
- Horizontal scaling support
- Load balancing for webhook endpoints
- Database partitioning for large alert volumes

## Monitoring and Analytics

### Metrics Tracked
- Notification success/failure rates
- Channel-specific delivery statistics
- Alert frequency and patterns
- System performance impact

### Dashboards
- Real-time notification status
- Alert trend analysis
- Channel health monitoring
- Performance metrics

## Support and Maintenance

### Regular Tasks
- Monitor notification delivery rates
- Review and update alert thresholds
- Rotate API keys and credentials
- Clean up old alert history data

### Updates and Patches
- Keep dependencies updated
- Monitor security advisories
- Test notification channels regularly
- Backup configuration files

## Contributing

### Development Setup
```bash
# Clone repository
git clone <repository-url>

# Install development dependencies
pip install -r notification_requirements.txt
pip install -r dev-requirements.txt

# Run tests
python3 -m pytest tests/

# Format code
black notification_integrations.py
flake8 notification_integrations.py
```

### Adding New Channels
1. Create new notifier class inheriting from base notifier
2. Implement `send_notification()` method
3. Add channel to `NotificationChannel` enum
4. Update `NotificationManager` to include new notifier
5. Add configuration options
6. Write tests for new channel

---

## Files in this System

- `notification_integrations.py` - Core notification system
- `test_notifications.py` - Comprehensive test suite
- `setup_notifications.sh` - Interactive configuration script
- `monitoring_notification_bridge.py` - Monitoring system integration
- `notification_config.json.template` - Configuration template
- `notification_requirements.txt` - Python dependencies
- `NOTIFICATION_SYSTEM_README.md` - This documentation

## Quick Reference

### Send Alert
```python
await manager.send_alert("Title", "Message", NotificationPriority.HIGH)
```

### Record Metric
```python
bridge.record_metric("cpu_usage", 85.2, "%", "server-01")
```

### Check Health
```python
health = bridge.get_system_health_summary()
```

---

**Last Updated**: August 27, 2025  
**Version**: 1.0  
**Maintainer**: Pixelated Empathy AI Team
