---
# GitLab CI/CD Pipeline for Pixelated AI Module
# This configuration uses uv for Python package management

stages:
- validate
- test
- build
- deploy

variables:
  # Python and uv configuration
  PYTHON_VERSION: "3.11"
  UV_VERSION: "latest"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

  # Container configuration
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE/ai:$CI_COMMIT_SHA
  CONTAINER_IMAGE_LATEST: $CI_REGISTRY_IMAGE/ai:latest

cache:
  key:
    files:
    - pyproject.toml
    - uv.lock
    prefix: $CI_COMMIT_REF_SLUG
  paths:
  - .cache/pip
  - .venv/

# Install uv and Python dependencies
.uv_setup: &uv_setup
  image: python:3.11-slim
  before_script:
  - echo "ðŸ“¦ Installing uv package manager..."
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  - export PATH="$HOME/.cargo/bin:$PATH"
  - uv --version
  - echo "ðŸ“¥ Installing project dependencies..."
  - uv sync --frozen
  - uv pip list

# Validate Python code syntax and configuration
validate:python:
  <<: *uv_setup
  stage: validate
  script:
  - echo "âœ… Validating Python syntax and imports..."
  - uv run python -m py_compile $(find . -name "*.py" -not -path "./.venv/*" -not -path "./.*")
  - echo "âœ… Checking pyproject.toml configuration..."
  - uv run python -c "import tomllib; f = open('pyproject.toml', 'rb'); tomllib.load(f); f.close()"
  only:
  - branches
  - merge_requests

# Run linting and formatting checks
lint:python:
  <<: *uv_setup
  stage: validate
  script:
  - echo "ðŸ” Running code quality checks..."
  - uv run ruff check . || true
  - uv run black --check . || true
  allow_failure: true
  only:
  - branches
  - merge_requests

# Run unit tests with pytest
test:unit:
  <<: *uv_setup
  stage: test
  script:
  - echo "ðŸ§ª Running unit tests..."
  - uv run pytest tests/ -v --tb=short --color=yes
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
    - htmlcov/
    expire_in: 1 week
  only:
  - branches
  - merge_requests

# Type checking with mypy (optional, allow failure)
test:typecheck:
  <<: *uv_setup
  stage: test
  script:
  - echo "ðŸ” Running type checks..."
  - uv run mypy . --ignore-missing-imports || true
  allow_failure: true
  only:
  - branches
  - merge_requests

# Build Docker image for AI services
build:docker:
  stage: build
  image: docker:27-dind
  services:
  - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  before_script:
  - echo "ðŸ” Logging in to GitLab Container Registry..."
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
  - echo "ðŸ—ï¸ Building Docker image for AI module..."
  - |
    if [ -f "Dockerfile" ]; then
      docker build -t $CONTAINER_IMAGE -t $CONTAINER_IMAGE_LATEST .
      docker push $CONTAINER_IMAGE
      docker push $CONTAINER_IMAGE_LATEST
      echo "âœ… Docker images built and pushed successfully"
    else
      echo "âš ï¸ No Dockerfile found, skipping Docker build"
    fi
  only:
  - master
  - main
  - tags

# Deploy to staging (optional)
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
  - apk add --no-cache curl
  script:
  - echo "ðŸš€ Deploying AI module to staging environment..."
  - echo "Container image: $CONTAINER_IMAGE"
  - echo "âš ï¸ Deployment logic not implemented yet"
  environment:
    name: staging
    url: https://staging.pixelatedempathy.com
  only:
  - master
  - main
  when: manual

# Deploy to production (manual trigger only)
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
  - apk add --no-cache curl
  script:
  - echo "ðŸš€ Deploying AI module to production environment..."
  - echo "Container image: $CONTAINER_IMAGE"
  - echo "âš ï¸ Deployment logic not implemented yet"
  environment:
    name: production
    url: https://pixelatedempathy.com
  only:
  - tags
  when: manual
